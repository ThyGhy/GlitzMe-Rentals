{% extends "admin/base.html" %}

{% block title %}{{ action }} Team Member - GlitzME Admin{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">
        <i class="fas fa-user"></i> {{ action }} Team Member
    </h1>
    <a href="{{ url_for('admin_team') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Team
    </a>
</div>

<div class="form-layout">
    <div class="content-card">
        <h3><i class="fas fa-edit"></i> Team Member Details</h3>
        <form method="POST" style="margin-top: 2rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                <div class="form-group">
                    <label for="name" class="form-label">
                        <i class="fas fa-user"></i> What's this person's name?
                    </label>
                    <input type="text" class="form-input" id="name" name="name" 
                           value="{{ member.name if member else '' }}" 
                           placeholder="e.g., John Smith" required>
                </div>
                <div class="form-group">
                    <label for="role" class="form-label">
                        <i class="fas fa-briefcase"></i> What's their role or title?
                    </label>
                    <input type="text" class="form-input" id="role" name="role" 
                           value="{{ member.role if member else '' }}" 
                           placeholder="e.g., Founder & Creative Director" required>
                </div>
            </div>
            
            <!-- Image Selection Section -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-camera"></i> Choose a Professional Photo
                </label>
                <div class="image-selection-container">
                    <input type="hidden" id="image_path" name="image_path" value="{{ member.image_path if member else '' }}" required>
                    
                    <div class="image-upload-area" onclick="document.getElementById('image_upload').click()">
                        <div class="upload-content">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Upload New Photo</p>
                            <small>Click to browse files</small>
                        </div>
                        <input type="file" id="image_upload" accept="image/*" style="display: none;">
                    </div>
                    
                    <div class="divider-text">
                        <span>or choose from existing</span>
                    </div>
                    
                    <div class="existing-images">
                        <div class="image-grid" id="image-grid">
                            <div class="loading-message" style="grid-column: 1 / -1; text-align: center; padding: 2rem; opacity: 0.7;">
                                <i class="fas fa-spinner fa-spin"></i> Loading photos...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Image Section -->
            <div class="form-group" style="background: rgba(255, 255, 255, 0.03); padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem;">
                <h4 style="margin-bottom: 1rem; color: var(--primary-blue-vibrant);">
                    <i class="fas fa-mobile-alt"></i> Mobile Photo (Optional)
                </h4>
                <p style="opacity: 0.8; margin-bottom: 1.5rem; font-size: 0.9rem;">
                    Want a different photo for mobile devices? Upload one here. Otherwise, we'll use the main photo.
                </p>
                <div class="form-group">
                    <label for="mobile_image_path" class="form-label">
                        <i class="fas fa-mobile-alt"></i> Mobile-optimized photo
                    </label>
                    <div class="image-selection-container" style="border: 1px solid rgba(255, 255, 255, 0.1);">
                        <input type="hidden" id="mobile_image_path" name="mobile_image_path" value="{{ member.mobile_image_path if member else '' }}">
                        
                        <div class="image-upload-area" onclick="document.getElementById('mobile_image_upload').click()" style="padding: 1rem; margin-bottom: 1rem;">
                            <div class="upload-content">
                                <i class="fas fa-mobile-alt"></i>
                                <p style="font-size: 1rem;">Upload Mobile Photo</p>
                                <small>Optional - for smaller screens</small>
                            </div>
                            <input type="file" id="mobile_image_upload" accept="image/*" style="display: none;">
                        </div>
                        
                        <div style="text-align: center;">
                            <button type="button" onclick="clearMobileImage()" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-times"></i> Use Main Photo for Mobile
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            
            
            {% if member %}
            <div class="form-checkbox">
                <input type="checkbox" id="is_active" name="is_active" 
                       {% if member.is_active %}checked{% endif %}>
                <label for="is_active">
                    <i class="fas fa-eye"></i> Show this person on the website
                </label>
            </div>
            {% endif %}
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
                <a href="{{ url_for('admin_team') }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> {{ action }} Team Member
                </button>
            </div>
        </form>
    </div>
    
    <!-- Preview Panel -->
    <div class="content-card preview-card">
        <h3><i class="fas fa-eye"></i> Preview</h3>
        
        <div class="preview-container" style="margin-top: 1.5rem;">
            <div class="image-preview-large" id="image-preview" style="text-align: center; margin-bottom: 1rem;">
                {% if member and member.image_path %}
                <img src="{{ url_for('static', filename=member.image_path) }}" 
                     alt="{{ member.name }}" 
                     style="max-width: 100%; max-height: 250px; border-radius: 50%; object-fit: cover; aspect-ratio: 1;"
                     onerror="this.src='{{ url_for('static', filename='Images/Logos/GMLogo-mobile.webp') }}'; this.alt='Image not found';">
                {% else %}
                <div style="padding: 4rem 2rem; background: rgba(255, 255, 255, 0.05); border-radius: 10px; border: 2px dashed rgba(255, 255, 255, 0.2);">
                    <i class="fas fa-user-circle" style="font-size: 3rem; opacity: 0.5; margin-bottom: 1rem; display: block;"></i>
                    <p style="opacity: 0.7;">Choose a photo to see preview</p>
                </div>
                {% endif %}
            </div>
            
            <div class="preview-details" style="text-align: center;">
                <h4 id="preview-name">{{ member.name if member else 'Team Member Name' }}</h4>
                <p id="preview-role" style="color: var(--primary-blue-vibrant); font-weight: 600; margin-bottom: 1rem;">
                    {{ member.role if member else 'Job Title' }}
                </p>
                
            </div>
        </div>
        
        <div style="margin-top: 2rem; padding: 1rem; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border: 1px solid rgba(255, 193, 7, 0.3);">
            <h5 style="color: #ffc107; margin-bottom: 0.5rem;">
                <i class="fas fa-lightbulb"></i> Photo Tips
            </h5>
            <ul style="font-size: 0.85rem; color: #ffc107; margin: 0;">
                <li>Use professional headshots when possible</li>
                <li>Square photos work best (1:1 ratio)</li>
                <li>Good lighting and clear background</li>
                <li>Keep team photo style consistent</li>
            </ul>
        </div>
    </div>
</div>

<style>
.form-layout{display:grid;grid-template-columns:1fr 400px;gap:2rem;align-items:start}
.preview-card{position:sticky;top:2rem}
@media(max-width:768px){
  .form-layout{grid-template-columns:1fr;gap:1rem}
  .preview-card{position:static}
}
</style>

<style>
.image-selection-container {
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.03);
}

.image-upload-area {
    border: 2px dashed rgba(44, 110, 184, 0.5);
    border-radius: 10px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(44, 110, 184, 0.1);
    margin-bottom: 1.5rem;
}

.image-upload-area:hover {
    border-color: var(--primary-blue-vibrant);
    background: rgba(44, 110, 184, 0.2);
}

.upload-content i {
    font-size: 2.5rem;
    color: var(--primary-blue-vibrant);
    margin-bottom: 1rem;
    display: block;
}

.upload-content p {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.upload-content small {
    opacity: 0.7;
}

.divider-text {
    text-align: center;
    position: relative;
    margin: 1.5rem 0;
}

.divider-text:before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: rgba(255, 255, 255, 0.2);
}

.divider-text span {
    background: var(--primary-blue);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    position: relative;
    z-index: 1;
}

.image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.75rem;
    max-height: 300px;
    overflow-y: auto;
}

.image-option {
    position: relative;
    aspect-ratio: 1;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.image-option:hover {
    transform: scale(1.05);
    border-color: var(--primary-blue-vibrant);
}

.image-option.selected {
    border-color: var(--primary-blue-vibrant);
    box-shadow: 0 0 0 2px rgba(59, 123, 201, 0.3);
}

.image-option img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-option .image-name {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 0.25rem;
    font-size: 0.7rem;
    text-align: center;
}
</style>

<script>
// Real-time preview updates
document.getElementById('name').addEventListener('input', function() {
    document.getElementById('preview-name').textContent = this.value || 'Team Member Name';
});

document.getElementById('role').addEventListener('input', function() {
    document.getElementById('preview-role').textContent = this.value || 'Job Title';
});

// Removed bio input handling

// Load existing images
async function loadExistingImages() {
    try {
        const response = await fetch('{{ url_for("admin_api_images") }}');
        const images = await response.json();
        const grid = document.getElementById('image-grid');
        
        // Clear loading message
        grid.innerHTML = '';
        
        if (images.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; opacity: 0.7;">No images found</div>';
            return;
        }
        
        images.forEach(imagePath => {
            const option = document.createElement('div');
            option.className = 'image-option';
            option.onclick = () => selectImage(imagePath, option);
            
            const img = document.createElement('img');
            img.src = `/static/${imagePath}`;
            img.alt = imagePath.split('/').pop();
            
            const name = document.createElement('div');
            name.className = 'image-name';
            name.textContent = imagePath.split('/').pop();
            
            option.appendChild(img);
            option.appendChild(name);
            grid.appendChild(option);
            
            // Mark as selected if this is the current image
            if (document.getElementById('image_path').value === imagePath) {
                option.classList.add('selected');
            }
        });
    } catch (error) {
        console.error('Error loading images:', error);
        const grid = document.getElementById('image-grid');
        grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #ff6b7a;">Error loading images. Please refresh the page.</div>';
    }
}

function selectImage(imagePath, element) {
    // Remove selection from all options
    document.querySelectorAll('.image-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Select clicked option
    element.classList.add('selected');
    
    // Update hidden input
    document.getElementById('image_path').value = imagePath;
    
    // Update preview with circular crop
    const preview = document.getElementById('image-preview');
    preview.innerHTML = `<img src="/static/${imagePath}" 
                                alt="Preview" 
                                style="max-width: 100%; max-height: 250px; border-radius: 50%; object-fit: cover; aspect-ratio: 1;">`;
}

function clearMobileImage() {
    document.getElementById('mobile_image_path').value = '';
    // You could add visual feedback here
    alert('Mobile image cleared - main photo will be used for mobile devices.');
}

// File upload functionality
document.getElementById('image_upload').addEventListener('change', function() {
    if (this.files && this.files[0]) {
        const file = this.files[0];
        
        // Show preview immediately
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('image-preview');
            preview.innerHTML = `<img src="${e.target.result}" 
                                      alt="Uploaded preview" 
                                      style="max-width: 100%; max-height: 250px; border-radius: 50%; object-fit: cover; aspect-ratio: 1;">`;
        };
        reader.readAsDataURL(file);
        
        // Here you would typically upload the file to the server
        alert('Image upload functionality will be implemented by your developer. For now, please use existing images.');
    }
});

// Mobile image upload functionality
document.getElementById('mobile_image_upload').addEventListener('change', function() {
    if (this.files && this.files[0]) {
        const file = this.files[0];
        alert('Mobile image upload functionality will be implemented by your developer. For now, please use the clear button or existing images.');
    }
});

// Load existing images when page loads
document.addEventListener('DOMContentLoaded', loadExistingImages);
</script>
{% endblock %}